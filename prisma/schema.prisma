generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Merchant {
  id                  Int                @id @default(autoincrement())
  name                String             @db.VarChar(255)
  surname             String             @db.VarChar(255)
  companyNumber       String?
  companyJurisdiction String?            @db.Char(2)
  fee                 Decimal            @default(6.50) @db.Decimal(4, 2)
  walletAddress       String             @unique
  phoneNumber         String?            @unique
  rainId              String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  userId              Int                @unique
  addressId           BigInt
  registeredAddress   PhysicalAddress    @relation(fields: [addressId], references: [id])
  user                User               @relation(fields: [userId], references: [id])
  Buyers              Buyer[]
  Compliance          Compliance[]
  Orders              Transaction[]
  Employees           MerchantEmployee[]

  @@unique([companyNumber, companyJurisdiction])
}

model Buyer {
  id             BigInt           @id @default(autoincrement())
  name           String           @db.VarChar(255)
  walletAddress  String?          @unique
  phoneNumber    String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  merchantId     Int
  addressId      BigInt?
  userId         Int              @unique
  user           User             @relation(fields: [userId], references: [id])
  billingAddress PhysicalAddress? @relation(fields: [addressId], references: [id])
  merchant       Merchant         @relation(fields: [merchantId], references: [id])
  compliance     Compliance[]
  orders         Transaction[]
}

model Compliance {
  id                       String             @id @default(uuid()) @db.Uuid
  type                     AccountType
  verificationDocumentLink String             @unique
  termsOfServiceLink       String             @unique
  verificationStatus       VerificationStatus @default(NOT_STARTED)
  termsOfServiceStatus     TosStatus          @default(PENDING)
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  buyerId                  BigInt?
  merchantId               Int?
  buyer                    Buyer?             @relation(fields: [buyerId], references: [id])
  merchant                 Merchant?          @relation(fields: [merchantId], references: [id])
}

model Transaction {
  id               String            @id @default(uuid())
  status           TransactionStatus
  partnerTokenId   String
  partnerRequestId String
  currency         String            @db.Char(3)
  amount           BigInt
  tip              Decimal?          @default(0.00) @db.Decimal(4, 2)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  buyerId          BigInt
  merchantId       Int
  addressId        BigInt?
  shippingAddress  PhysicalAddress?  @relation(fields: [addressId], references: [id])
  buyer            Buyer             @relation(fields: [buyerId], references: [id])
  merchant         Merchant          @relation(fields: [merchantId], references: [id])
}

model PhysicalAddress {
  id          BigInt        @id @default(autoincrement())
  street1     String        @db.VarChar(50)
  street2     String?       @db.VarChar(50)
  city        String        @db.VarChar(50)
  postcode    String?       @db.VarChar(25)
  state       String?       @db.Char(2)
  country     String        @db.Char(2)
  type        AddressType
  Buyer       Buyer[]
  Merchant    Merchant[]
  Transaction Transaction[]
}

model RegisteredPasskey {
  id           Int                 @id @default(autoincrement())
  name         String?             @db.VarChar(255)
  credentialId String              @unique
  publicKey    String
  algorithm    CredentialAlgorithm @default(ES256)
  userId       Int
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id])
}

model MerchantEmployee {
  id         Int      @id @default(autoincrement())
  rain       String?  @unique @db.VarChar(36)
  owner      Boolean  @default(false)
  merchantId Int
  userId     Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])
  merchant   Merchant @relation(fields: [merchantId], references: [id])
}

model User {
  id                 Int                 @id @default(autoincrement())
  email              String              @unique
  username           String?             @unique @db.VarChar(15)
  role               UserRole
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  registeredPasskeys RegisteredPasskey[]
  merchantProfile    Merchant?
  buyerProfile       Buyer?
  apiKeys            ApiKey[]
  employeeProfiles   MerchantEmployee[]
}

model ApiKey {
  id         String    @id @default(uuid())
  key        String    @unique
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?
  expiresAt  DateTime?
  isActive   Boolean   @default(true)
  userId     Int
  user       User      @relation(fields: [userId], references: [id])

  @@index([key])
}

enum UserRole {
  ADMIN
  MERCHANT
  BUYER
}

enum TransactionStatus {
  PENDING
  COMPLETE
  FAILED
  ERROR
}

enum AddressType {
  BILLING
  SHIPPING
  REGISTERED
}

enum VerificationStatus {
  NOT_STARTED
  PENDING
  INCOMPLETE
  AWAITING_UBO
  MANUAL_REVIEW
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum TosStatus {
  PENDING
  APPROVED
}

enum AccountType {
  BUSINESS
  INDIVIDUAL
}

enum CredentialAlgorithm {
  RS256
  ES256
}
